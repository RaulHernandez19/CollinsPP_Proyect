<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CesiumJS Orrery</title>
    <link href="node_modules/cesium/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noisejs/2.0.0/perlin.min.js"></script>
    <style>
        /* Estilos para el contenedor de Cesium */
        #cesiumContainer {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Estilos para el panel de información */
        #infoPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            max-height: 400px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            display: none; /* Oculto por defecto */
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000; /* Asegura que esté por encima del visor */
        }

        #infoPanel h2 {
            margin-top: 0;
            font-size: 1.5em;
        }

        #closeInfoPanel {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 1.2em;
            color: #333;
        }

        /* Estilos adicionales opcionales */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        /* Estilos responsivos */
        @media (max-width: 600px) {
            #infoPanel {
                width: 90%;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
            }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <div id="infoPanel">
        <span id="closeInfoPanel">&times;</span>
        <h2 id="planetName">Información del Objeto</h2>
        <p id="planetInfo">Cargando información...</p>
    </div>

    <script src="node_modules/cesium/Build/Cesium/Cesium.js"></script>
    <script>
        // Asigna tu Cesium Ion Access Token personalizado
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyYzJhZjE2NC1mOWQ2LTQ4NTItODRlMC0zZDkyMWMyYWI4ODMiLCJpZCI6MjQ2MTMxLCJpYXQiOjE3MjgxNTM2MTR9.BDbM94S9z_B2W2sq25ib4WgLdYVQgZnYegUTdWEuIes';

        // Inicializar el visor de Cesium
        const viewer = new Cesium.Viewer('cesiumContainer', {
            timeline: false,
            animation: false,
            fullscreenButton: false,
            homeButton: false,
            sceneModePicker: false,
            baseLayerPicker: false,
            geocoder: false,
            navigationHelpButton: false,
            infoBox: false,
            selectionIndicator: false
        });

        const infoPanel = document.getElementById('infoPanel');
        const closeInfoPanel = document.getElementById('closeInfoPanel');
        const planetName = document.getElementById('planetName');
        const planetInfo = document.getElementById('planetInfo');

        // Cerrar el panel de información cuando se hace clic en la "X"
        closeInfoPanel.onclick = () => {
            infoPanel.style.display = 'none';
        };

        async function obtenerDatosNEO() {
            const url = "https://ssd-api.jpl.nasa.gov/sbdb_query.api?fields=full_name,epoch,e,a,i,om,w,ma,diameter,neo,kind&sb-class=IEO";
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Error al obtener datos NEO:', error);
            }
        }

        function keplerianToCartesian(params) {
            const semiMajorAxis = params.a;
            const eccentricity = params.e;
            const inclination = params.i * (Math.PI / 180);
            const longitudeOfAscendingNode = params.om * (Math.PI / 180);
            const argumentOfPeriapsis = params.w * (Math.PI / 180);
            const meanAnomaly = params.ma * (Math.PI / 180);

            const E = meanAnomaly + (eccentricity * Math.sin(meanAnomaly));
            const x = semiMajorAxis * (Math.cos(E) - eccentricity);
            const y = semiMajorAxis * Math.sqrt(1 - eccentricity * eccentricity) * Math.sin(E);

            const xRot = (x * (Math.cos(argumentOfPeriapsis) * Math.cos(longitudeOfAscendingNode) - Math.sin(argumentOfPeriapsis) * Math.sin(longitudeOfAscendingNode) * Math.cos(inclination))) -
                         (y * (Math.sin(argumentOfPeriapsis) * Math.cos(longitudeOfAscendingNode) + Math.cos(argumentOfPeriapsis) * Math.sin(longitudeOfAscendingNode) * Math.cos(inclination)));

            const yRot = (x * (Math.cos(argumentOfPeriapsis) * Math.sin(longitudeOfAscendingNode) + Math.sin(argumentOfPeriapsis) * Math.cos(longitudeOfAscendingNode) * Math.cos(inclination))) +
                         (y * (Math.cos(argumentOfPeriapsis) * Math.cos(inclination)));

            const z = y * Math.sin(inclination);

            return new Cesium.Cartesian3(xRot * 149597870.7, yRot * 149597870.7, z * 149597870.7);
        }

        function agregarNEOs(neoData) {
            neoData.forEach(neo => {
                const params = {
                    a: neo[4],
                    e: neo[3],
                    i: neo[5],
                    w: neo[6],
                    om: neo[7],
                    ma: neo[2],
                    diameter: neo[8] || 1
                };

                const position = keplerianToCartesian(params);
                const radius = params.diameter / 2 * 1000;

                const asteroid = viewer.entities.add({
                    position: position,
                    ellipsoid: {
                        radii: new Cesium.Cartesian3(
                            radius * (1 + Math.random() * 0.6 - 0.3),
                            radius * (1 + Math.random() * 0.6 - 0.3),
                            radius * (1 + Math.random() * 0.6 - 0.3)
                        ),
                        material: new Cesium.ImageMaterialProperty({
                            image: 'asteroid-1/ground_0010_color_1k.jpg',
                            repeat: new Cesium.Cartesian2(1.0, 1.0)
                        })
                    },
                    label: {
                        text: neo[0],
                        font: '12pt monospace',
                        fillColor: Cesium.Color.WHITE
                    }
                });

                // Asociar los datos del asteroide con la entidad
                asteroid.planetData = {
                    name: neo[0],
                    diameter: params.diameter,
                    eccentricity: params.e,
                    inclination: params.i
                };
            });
        }

        // Agregar la Tierra como una entidad clickeable
        const earth = viewer.entities.add({
            name: 'Earth',
            position: Cesium.Cartesian3.fromDegrees(0.0, 0.0, 0.0),
            model: {
                uri: Cesium.IonResource.fromAssetId(3), // Modelo de la Tierra
                minimumPixelSize: 128,
                maximumScale: 20000
            },
            ellipsoid: {
                radii: new Cesium.Cartesian3(6378137.0, 6378137.0, 6378137.0),
                material: Cesium.Color.BLUE.withAlpha(0.0), // Hacer invisible el elipsoide
                show: false // Ocultar el elipsoide para evitar conflictos visuales
            }
        });
        earth.planetData = {
            name: 'Earth',
            diameter: 12742,
            eccentricity: 0.0167,
            inclination: 0
        };

        // Mostrar el panel de información al hacer doble clic en una entidad
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function (movement) {
            const pickedObject = viewer.scene.pick(movement.position);
            if (Cesium.defined(pickedObject)) {
                const entity = pickedObject.id;

                if (entity.planetData) {
                    planetName.textContent = entity.planetData.name;
                    planetInfo.innerHTML = `
                        <strong>Diámetro:</strong> ${entity.planetData.diameter} km<br>
                        <strong>Excentricidad:</strong> ${entity.planetData.eccentricity}<br>
                        <strong>Inclinación:</strong> ${entity.planetData.inclination}°
                    `;
                    infoPanel.style.display = 'block';
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

        obtenerDatosNEO().then(neoData => {
            if (neoData) {
                agregarNEOs(neoData);
            }
        });
    </script>
</body>
</html>