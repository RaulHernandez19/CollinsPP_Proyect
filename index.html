<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CesiumJS Orrery</title>
    <link href="node_modules/cesium/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        /* Estilos para el contenedor de Cesium */
        #cesiumContainer {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Estilos para el panel de información */
        #infoPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            max-height: 400px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            display: none; /* Oculto por defecto */
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000; /* Asegura que esté por encima del visor */
        }

        #infoPanel h2 {
            margin-top: 0;
            font-size: 1.5em;
        }

        #closeInfoPanel {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 1.2em;
            color: #333;
        }

        /* Estilos adicionales opcionales */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        /* Estilos responsivos */
        @media (max-width: 600px) {
            #infoPanel {
                width: 90%;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
            }
        }

        /* Ocultar cualquier indicador de selección residual */
        .cesium-selectionIndicator {
            display: none !important;
        }

        /* Opcional: Ocultar el tooltip de selección si existe */
        .cesium-tooltip {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="infoPanel">
        <span id="closeInfoPanel">&times;</span>
        <h2>Información del Cuerpo Celeste</h2>
        <p id="planetInfo">Cargando información...</p>
    </div>
    <!-- Incluir CesiumJS -->
    <script src="node_modules/cesium/Build/Cesium/Cesium.js"></script>
    <script>
        // Asigna tu Cesium Ion Access Token personalizado
        Cesium.Ion.defaultAccessToken = 'TU_CESIUM_ION_ACCESS_TOKEN_AQUÍ';

        // Inicializar el visor de Cesium
        const viewer = new Cesium.Viewer('cesiumContainer', {
            sceneMode: Cesium.SceneMode.SCENE3D,
            globe: false, // Desactiva la visualización de la Tierra
            skyBox: false, // Opcional: desactivar el skybox
            skyAtmosphere: false, // Opcional: desactivar la atmósfera
            timeline: false, // Eliminar el timeline (parte inferior)
            animation: false, // Eliminar el widget de animación (parte inferior izquierda)
            fullscreenButton: false, // Eliminar botón de pantalla completa
            homeButton: false, // Eliminar botón de inicio
            sceneModePicker: false, // Eliminar selector de modos de escena
            baseLayerPicker: false, // Eliminar selector de capa base
            geocoder: false, // Eliminar el geocodificador
            navigationHelpButton: false, // Eliminar botón de ayuda de navegación
            infoBox: false, // Eliminar el cuadro de información
            selectionIndicator: false // Eliminar el indicador de selección
        });

        // Establecer el color de fondo negro para simular el espacio
        viewer.scene.backgroundColor = Cesium.Color.BLACK;

        // Definir la posición del Sol en el centro
        const sunPosition = new Cesium.Cartesian3(0, 0, 0);

        // Agregar el Sol al visor
        viewer.entities.add({
            name: 'Sun',
            position: sunPosition,
            ellipsoid: {
                radii: new Cesium.Cartesian3(696340000 * 10, 696340000 * 10, 696340000 * 10), // Escalar el Sol
                material: Cesium.Color.YELLOW.withAlpha(0.8),
            },
            label: {
                text: 'Sun',
                font: '14pt sans-serif',
                fillColor: Cesium.Color.WHITE,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                pixelOffset: new Cesium.Cartesian2(0, -20),
            }
        });

        // Factor para escalar el tamaño de los planetas
        const escalaTamano = 1000;

        // Mapeo de radios planetarios en metros (escalados)
        const radios = {
            mercury: 2439700 * escalaTamano,
            venus: 6051800 * escalaTamano,
            earth: 6371000 * escalaTamano,
            mars: 3389500 * escalaTamano,
            jupiter: 69911000 * escalaTamano,
            saturn: 58232000 * escalaTamano,
            uranus: 25362000 * escalaTamano,
            neptune: 24622000 * escalaTamano,
            pluto: 1188300 * escalaTamano // Opcional
        };

        // Función para convertir AU a metros
        function auToMeters(au) {
            return au * 149597870700; // 1 AU = 149,597,870,700 metros
        }

        // Función para obtener posiciones de planetas desde la API
        async function obtenerPosicionesPlanetas(fecha) {
            try {
                // Asegúrate de que la URL apunte al servidor Flask correcto
                const response = await fetch(`http://127.0.0.1:5000/api/planet_positions?fecha=${fecha}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error al obtener posiciones de planetas:', error);
                return null;
            }
        }

        // Función para agregar planetas al visor
        async function agregarPlanetas() {
            const fecha = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
            const posiciones = await obtenerPosicionesPlanetas(fecha);

            if (!posiciones) {
                console.error('No se pudieron obtener las posiciones de los planetas.');
                return;
            }

            for (const [nombre, pos] of Object.entries(posiciones)) {
                if (pos.error) {
                    console.warn(`No se pudo obtener la posición de ${nombre}: ${pos.error}`);
                    continue;
                }

                // Convertir coordenadas de AU a metros
                const x = auToMeters(pos.x);
                const y = auToMeters(pos.y);
                const z = auToMeters(pos.z);

                const cesiumPosition = new Cesium.Cartesian3(x, y, z);

                // Agregar el planeta al visor
                viewer.entities.add({
                    name: nombre.charAt(0).toUpperCase() + nombre.slice(1),
                    position: cesiumPosition,
                    ellipsoid: {
                        radii: new Cesium.Cartesian3(radios[nombre], radios[nombre], radios[nombre]),
                        material: Cesium.Color.fromRandom({
                            alpha: 1.0
                        }),
                    },
                    label: {
                        text: nombre.charAt(0).toUpperCase() + nombre.slice(1),
                        font: '14pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        verticalOrigin: Cesium.VerticalOrigin.TOP,
                        pixelOffset: new Cesium.Cartesian2(0, 20),
                    }
                });
            }
        }

        // Llamar a la función para agregar planetas
        agregarPlanetas();

        // Configurar la cámara para ver el sistema solar
        viewer.camera.setView({
            destination: new Cesium.Cartesian3(0, -3e11, 1e11),
            orientation: {
                heading: Cesium.Math.toRadians(0.0),
                pitch: Cesium.Math.toRadians(-15.0),
                roll: 0.0
            }
        });

        // Manejar el cierre del panel de información
        document.getElementById('closeInfoPanel').onclick = function() {
            document.getElementById('infoPanel').style.display = 'none';
        };

        // Manejar clics en entidades para mostrar información
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function(click) {
            const pickedObject = viewer.scene.pick(click.position);
            if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
                const nombre = pickedObject.id.name;
                document.getElementById('infoPanel').style.display = 'block';
                document.getElementById('infoPanel').querySelector('h2').innerText = `Información de ${nombre}`;
                document.getElementById('infoPanel').querySelector('#planetInfo').innerText = `Detalles de ${nombre}...`;
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    </script>
</body>
</html>
